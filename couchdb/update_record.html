<!DOCTYPE html>
<html>
  <meta charset="UTF-8">
  <head>
    <title>JSONP test for couchdb</title>
    <script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
    <style type="text/css">
      body {
      font: 28px sans-serif;
      }
      .axis text {
          font-family: sans-serif;
          font-size: 22px;
    }
    </style>
  </head>
  <body>

  <h1>Test CouchDB record updates</h1>

  On the browser console the time stamp should show on success.

  <script>
obj = { "test": "test3", }; 

$.ajax({
   url: "http://localhost:5984/",
   type: 'get',
   dataType: 'jsonp',
   success: function(data) {
      console.log(data.couchdb+' version '+data.version);
      $.ajax({
        url: 'http://localhost:5984/jstest/id1',
        type: 'GET',
        dataType: 'jsonp',
        cache: false,
        crossDomain: true,
        }).done( function(data1) {
          console.log(data1)
          console.log(data1._rev)
          var obj2 = jQuery.extend(true, {}, data1);
          // delete obj2["_id"];
          // delete obj2["_rev"];
          // delete obj2["rev"];
          // obj2._id = data1._id ;
          // obj2._rev = data1._rev ;
          // obj2['_rev'] = data1['_rev'] ;
          obj2.time = new Date().getTime() / 1000;
          console.log('obj2',obj2);
          $.ajax({
            url: 'http://localhost:5984/jstest/id1',
            type: 'PUT',
            // async: false,
            contentType: "application/json",
            // contentType: "application/json; charset=utf-8",
            dataType: 'json',
            // cache: false,
            // crossDomain: true,
            data: JSON.stringify(obj2)
            }).done( function(data2) {
                  console.log("Returned object ",data2);
                  $.ajax({
                    url: 'http://localhost:5984/jstest/id1',
                    // type: 'GET',
                    // async: false,
                    dataType: 'jsonp',
                    // cache: false,
                    // crossDomain: true,
                    }).done( function(data3) {
                      console.log("FINAL: ",data3);
                      console.log(data3.time)
                            }
                           ).fail( function(d) { console.log("FAIL") }) 
            });
     })}});

    </script>
  </body>
</html
